<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tenant Bedrock Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .login-form, .chat-interface { display: none; }
        .login-form.active, .chat-interface.active { display: block; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #007bff; color: white; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .chat-box { border: 1px solid #ddd; height: 400px; overflow-y: scroll; padding: 15px; margin: 15px 0; background-color: #fafafa; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .user { background-color: #007bff; color: white; text-align: right; }
        .agent { background-color: #e9ecef; }
        .tenant-info { background-color: #d4edda; padding: 15px; margin: 15px 0; border-radius: 4px; border: 1px solid #c3e6cb; }
        .error { color: #dc3545; margin: 10px 0; }
        .success { color: #28a745; margin: 10px 0; }
        .input-group { display: flex; gap: 10px; margin: 10px 0; }
        .logout-btn { background-color: #dc3545; }
        .logout-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Multi-Tenant Bedrock Chat</h1>
        
        <!-- Login Form -->
        <div id="loginForm" class="login-form active">
            <h2>Login</h2>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            <button onclick="login()">Login</button>
            <div id="loginError" class="error"></div>
            
            <hr style="margin: 30px 0;">
            <h3>New User Registration</h3>
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required>
            </div>
            <div class="form-group">
                <label for="regTenant">Organization:</label>
                <select id="regTenant">
                    <option value="acme-corp">Acme Corporation</option>
                    <option value="beta-inc">Beta Industries</option>
                    <option value="gamma-llc">Gamma LLC</option>
                </select>
            </div>
            <button onclick="register()">Register</button>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" class="chat-interface">
            <div class="tenant-info">
                <h3>Welcome!</h3>
                <div id="userInfo"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <div id="chatBox" class="chat-box"></div>
            
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 1;">
                <button onclick="sendMessage()">Send</button>
            </div>
            
            <div class="input-group">
                <button onclick="getUsage()">View Usage</button>
                <button onclick="getSessions()">View Sessions</button>
                <button onclick="getAgenticCapabilities()">Agentic Features</button>
            </div>
            
            <div id="usageInfo"></div>
        </div>
    </div>

    <script>
        // Configuration - Update these with your deployed values
        const CONFIG = {
            userPoolId: 'UPDATE_FROM_DEPLOYMENT',
            clientId: 'UPDATE_FROM_DEPLOYMENT', 
            region: 'us-east-1',
            apiUrl: 'http://localhost:8000'
        };

        let currentUser = null;
        let currentSession = null;
        let cognitoUser = null;

        // Initialize Cognito
        const poolData = {
            UserPoolId: CONFIG.userPoolId,
            ClientId: CONFIG.clientId
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const tenantId = document.getElementById('regTenant').value;
            
            const attributeList = [
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'email',
                    Value: email
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'custom:tenant_id',
                    Value: tenantId
                })
            ];

            userPool.signUp(email, password, attributeList, null, (err, result) => {
                if (err) {
                    document.getElementById('registerError').textContent = err.message;
                    return;
                }
                document.getElementById('registerSuccess').textContent = 
                    'Registration successful! Please check your email for verification.';
                document.getElementById('registerError').textContent = '';
            });
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const authenticationData = {
                Username: email,
                Password: password
            };
            
            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            
            const userData = {
                Username: email,
                Pool: userPool
            };
            
            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: (result) => {
                    const idToken = result.getIdToken().getJwtToken();
                    const payload = result.getIdToken().payload;
                    
                    currentUser = {
                        email: payload.email,
                        tenant_id: payload['custom:tenant_id'],
                        user_id: payload.sub,
                        token: idToken
                    };
                    
                    showChatInterface();
                },
                onFailure: (err) => {
                    document.getElementById('loginError').textContent = err.message;
                }
            });
        }

        function showChatInterface() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('chatInterface').classList.add('active');
            
            document.getElementById('userInfo').innerHTML = 
                `<strong>User:</strong> ${currentUser.email}<br>
                 <strong>Organization:</strong> ${currentUser.tenant_id}<br>
                 <strong>User ID:</strong> ${currentUser.user_id}`;
            
            createSession();
        }

        async function createSession() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    currentSession = await response.json();
                    addMessageToChat('system', `Session created: ${currentSession.session_id}`);
                } else {
                    addMessageToChat('system', 'Failed to create session');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        async function sendMessage() {
            if (!currentSession) {
                addMessageToChat('system', 'No active session');
                return;
            }
            
            const message = document.getElementById('messageInput').value;
            if (!message) return;
            
            addMessageToChat('user', message);
            document.getElementById('messageInput').value = '';
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        tenant_context: {
                            tenant_id: currentUser.tenant_id,
                            user_id: currentUser.user_id,
                            session_id: currentSession.session_id
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessageToChat('agent', result.response);
                } else {
                    addMessageToChat('system', 'Failed to send message');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        function addMessageToChat(sender, message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function getUsage() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/usage`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const usage = await response.json();
                    document.getElementById('usageInfo').innerHTML = 
                        `<h3>Usage for ${usage.tenant_id}</h3>
                         <p>Total Messages: ${usage.total_messages}</p>
                         <p>Active Sessions: ${usage.sessions}</p>
                         <pre>${JSON.stringify(usage.metrics, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error getting usage:', error);
            }
        }

        async function getSessions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/sessions`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const sessions = await response.json();
                    document.getElementById('usageInfo').innerHTML = 
                        `<h3>Sessions for ${sessions.tenant_id}</h3>
                         <pre>${JSON.stringify(sessions.sessions, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error getting sessions:', error);
            }
        }

        function getAgenticCapabilities() {
            document.getElementById('usageInfo').innerHTML = 
                `<h3>ü§ñ Agentic Framework Capabilities</h3>
                 <p><strong>üß† Planning:</strong> Multi-step reasoning and task decomposition</p>
                 <p><strong>üîß Tool Calling:</strong> Action groups for tenant-specific operations</p>
                 <p><strong>üìö Knowledge Retrieval:</strong> RAG with tenant-scoped knowledge bases</p>
                 <p><strong>üîÑ Orchestration:</strong> Complex workflow management</p>
                 <p><strong>üìä Trace Analysis:</strong> Detailed agentic behavior tracking</p>
                 <p><strong>üè¢ Multi-Tenant:</strong> Complete tenant isolation and context propagation</p>`;
        }

        function logout() {
            if (cognitoUser) {
                cognitoUser.signOut();
            }
            currentUser = null;
            currentSession = null;
            cognitoUser = null;
            
            document.getElementById('chatInterface').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('usageInfo').innerHTML = '';
        }

        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>