<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Bedrock Agent Core</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amazon+Ember:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --aws-orange: #FF9900;
            --aws-dark: #232F3E;
            --aws-light: #FFFFFF;
            --aws-gray: #545B64;
            --aws-border: #D5DBDB;
            --aws-bg: #FAFAFA;
            --aws-hover: #EC7211;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #232F3E 0%, #37475A 100%);
            min-height: 100vh;
            color: var(--aws-dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--aws-light);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--aws-orange) 0%, var(--aws-hover) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--aws-dark);
            margin-bottom: 2px;
        }
        
        .logo-text p {
            font-size: 12px;
            color: var(--aws-gray);
            font-weight: 400;
        }
        
        .login-form, .chat-interface { display: none; }
        .login-form.active, .chat-interface.active { display: block; }
        
        .card {
            background: var(--aws-light);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--aws-dark);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--aws-border);
        }
        
        .form-group { margin-bottom: 20px; }
        
        label { 
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--aws-dark);
            font-size: 14px;
        }
        
        input, select { 
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--aws-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: var(--aws-light);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--aws-orange);
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
        }
        
        button { 
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--aws-orange) 0%, var(--aws-hover) 100%);
            color: var(--aws-light);
            width: 100%;
            padding: 14px;
            font-size: 15px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 0, 0.3);
        }
        
        .btn-secondary {
            background: var(--aws-dark);
            color: var(--aws-light);
        }
        
        .btn-secondary:hover {
            background: var(--aws-gray);
        }
        
        .btn-danger {
            background: #D13212;
            color: var(--aws-light);
        }
        
        .btn-danger:hover {
            background: #A82A0C;
        }
        
        .chat-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .chat-box { 
            background: var(--aws-light);
            border-radius: 12px;
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            scroll-behavior: smooth;
        }
        
        .chat-box::-webkit-scrollbar { width: 8px; }
        .chat-box::-webkit-scrollbar-track { background: var(--aws-bg); border-radius: 10px; }
        .chat-box::-webkit-scrollbar-thumb { background: var(--aws-border); border-radius: 10px; }
        .chat-box::-webkit-scrollbar-thumb:hover { background: var(--aws-gray); }
        
        .message { 
            margin-bottom: 16px;
            padding: 14px 18px;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user { 
            background: linear-gradient(135deg, var(--aws-orange) 0%, var(--aws-hover) 100%);
            color: var(--aws-light);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.agent { 
            background: var(--aws-bg);
            color: var(--aws-dark);
            border: 1px solid var(--aws-border);
            border-bottom-left-radius: 4px;
        }
        
        .message.system {
            background: var(--aws-dark);
            color: var(--aws-light);
            text-align: center;
            margin: 10px auto;
            font-size: 12px;
            max-width: 60%;
        }
        
        .message strong {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-area {
            background: var(--aws-light);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .message-input-group {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        #messageInput { 
            flex: 1;
            padding: 16px;
            font-size: 15px;
            min-height: 60px;
            resize: vertical;
            border: 2px solid var(--aws-border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
        }
        
        #messageInput:focus {
            border-color: var(--aws-orange);
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--aws-orange) 0%, var(--aws-hover) 100%);
            color: var(--aws-light);
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 0, 0.3);
        }
        
        .user-info-card {
            background: linear-gradient(135deg, var(--aws-dark) 0%, #37475A 100%);
            color: var(--aws-light);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .user-info-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info-card p {
            margin: 8px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .user-info-card strong {
            color: var(--aws-orange);
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-info { background: #0972D3; color: white; }
        .btn-success { background: #037F0C; color: white; }
        .btn-warning { background: #FF9900; color: white; }
        .btn-admin { background: #D13212; color: white; }
        
        .info-panel {
            background: var(--aws-light);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .info-panel::-webkit-scrollbar { width: 8px; }
        .info-panel::-webkit-scrollbar-track { background: var(--aws-bg); border-radius: 10px; }
        .info-panel::-webkit-scrollbar-thumb { background: var(--aws-border); border-radius: 10px; }
        
        .error { 
            background: #FDECEA;
            color: #D13212;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #D13212;
        }
        
        .success { 
            background: #E9F7EF;
            color: #037F0C;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #037F0C;
        }
        
        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--aws-border), transparent);
            margin: 30px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-premium { background: #FFD700; color: #232F3E; }
        .badge-advanced { background: #0972D3; color: white; }
        .badge-basic { background: #545B64; color: white; }
        .badge-admin { background: #D13212; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ü§ñ</div>
                <div class="logo-text">
                    <h1>AWS Bedrock Agent Core</h1>
                    <p>Multi-Tenant AI Chat Platform</p>
                </div>
            </div>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="login-form active">
            <div class="card">
                <h2 class="card-title">üîë Sign In</h2>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            <button class="btn-primary" onclick="login()">Sign In</button>
            <div id="loginError" class="error"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p style="color: var(--aws-gray); margin-bottom: 10px;">Don't have an account?</p>
                <button class="btn-secondary" onclick="showRegisterForm()" style="width: 100%;">Create Account</button>
            </div>
            </div>
        </div>
        
        <!-- Registration Form -->
        <div id="registerForm" class="login-form">
            <div class="card">
                <h2 class="card-title">‚ú® Create Account</h2>
            <div class="form-group">
                <label for="regFirstName">First Name:</label>
                <input type="text" id="regFirstName" placeholder="John" required>
            </div>
            <div class="form-group">
                <label for="regLastName">Last Name:</label>
                <input type="text" id="regLastName" placeholder="Doe" required>
            </div>
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required>
            </div>
            <div class="form-group">
                <label for="regTenant">Organization:</label>
                <select id="regTenant">
                    <option value="acme-corp">Acme Corporation</option>
                    <option value="beta-inc">Beta Industries</option>
                    <option value="gamma-llc">Gamma LLC</option>
                </select>
            </div>
            <div class="form-group">
                <label for="regTier">Subscription Tier:</label>
                <select id="regTier">
                    <option value="basic">Basic (Free) - 50 daily messages</option>
                    <option value="advanced">Advanced ($29/month) - 200 daily messages + MCP tools</option>
                    <option value="premium">Premium ($99/month) - 1000 daily messages + Full MCP access</option>
                </select>
            </div>
            <div class="form-group">
                <label for="regRole">User Role:</label>
                <select id="regRole">
                    <option value="user">Regular User</option>
                    <option value="admin">Admin (Cost Reports Access)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="register()">Create Account</button>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p style="color: var(--aws-gray); margin-bottom: 10px;">Already have an account?</p>
                <button class="btn-secondary" onclick="showLoginForm()" style="width: 100%;">Back to Sign In</button>
            </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" class="chat-interface">
            <div class="user-info-card">
                <h3>üëã Welcome Back!</h3>
                <div id="userInfo"></div>
                <button class="btn-danger" style="margin-top: 15px; width: auto;" onclick="logout()">Sign Out</button>
            </div>
            
            <div class="chat-container">
                <div class="card" style="padding: 0;">
                    <div id="chatBox" class="chat-box"></div>
                </div>
                
                <div class="input-area">
                    <div class="message-input-group">
                        <textarea id="messageInput" placeholder="Type your message here..."></textarea>
                        <button class="send-btn" onclick="sendMessage()">
                            <span>‚û§</span>
                            <span>Send</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">üõ†Ô∏è Quick Actions</h3>
                <div class="action-grid">
                    <button class="action-btn btn-info" onclick="getUsage()">üìä Usage</button>
                    <button class="action-btn btn-info" onclick="getSessions()">üìù Sessions</button>
                    <button class="action-btn btn-info" onclick="getSubscriptionInfo()">üéØ Subscription</button>
                </div>
                
                <div id="adminControls" style="display: none; margin-top: 20px;">
                    <h3 class="card-title" style="margin-top: 20px;">üîí Admin Controls</h3>
                    <div class="action-grid">
                        <button class="action-btn btn-admin" onclick="getAdminOverallCost()">Overall Cost</button>
                        <button class="action-btn btn-admin" onclick="getAdminPerUserCost()">Per User Cost</button>
                        <button class="action-btn btn-admin" onclick="getAdminServiceCost()">Service Cost</button>
                        <button class="action-btn btn-admin" onclick="getComprehensiveReport()">Full Report</button>
                    </div>
                </div>
            </div>
            
            <div id="usageInfo" class="info-panel" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuration - Update these with your deployed values
        const CONFIG = {
            userPoolId: 'YOUR_USER_POOL_ID',
            clientId: 'YOUR_CLIENT_ID',
            region: 'us-east-1',
            apiUrl: 'http://localhost:8000'
        };

        let currentUser = null;
        let currentSession = null;
        let cognitoUser = null;

        // Initialize Cognito
        const poolData = {
            UserPoolId: CONFIG.userPoolId,
            ClientId: CONFIG.clientId
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        async function register() {
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const tenantId = document.getElementById('regTenant').value;
            const role = document.getElementById('regRole').value;
            
            const attributeList = [
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'email',
                    Value: email
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'given_name',
                    Value: firstName
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'family_name',
                    Value: lastName
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'custom:tenant_id',
                    Value: tenantId
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'custom:subscription_tier',
                    Value: document.getElementById('regTier').value
                })
            ];

            userPool.signUp(email, password, attributeList, null, async (err, result) => {
                if (err) {
                    document.getElementById('registerError').textContent = err.message;
                    return;
                }
                
                // If admin role selected, add to admin group after verification
                const isAdmin = role === 'admin';
                
                // Show verification code input safely
                const successDiv = document.getElementById('registerSuccess');
                successDiv.textContent = 'Registration successful! Please check your email for verification code.';
                
                if (isAdmin) {
                    const adminMsg = document.createElement('div');
                    const strongEl = document.createElement('strong');
                    strongEl.style.color = '#dc3545';
                    strongEl.textContent = 'üîí Admin access will be granted after verification';
                    adminMsg.appendChild(strongEl);
                    successDiv.appendChild(adminMsg);
                }
                
                const verificationInput = document.createElement('input');
                verificationInput.type = 'text';
                verificationInput.id = 'verificationCode';
                verificationInput.placeholder = 'Enter verification code';
                verificationInput.style.cssText = 'margin: 10px 0; padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px;';
                
                const verifyButton = document.createElement('button');
                verifyButton.textContent = 'Verify';
                verifyButton.onclick = () => confirmSignUp(email, tenantId, isAdmin);
                verifyButton.style.cssText = 'margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;';
                
                successDiv.appendChild(verificationInput);
                successDiv.appendChild(verifyButton);
                document.getElementById('registerError').textContent = '';
            });
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const authenticationData = {
                Username: email,
                Password: password
            };
            
            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            
            const userData = {
                Username: email,
                Pool: userPool
            };
            
            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: (result) => {
                    const idToken = result.getIdToken().getJwtToken();
                    const payload = result.getIdToken().payload;
                    
                    currentUser = {
                        email: payload.email,
                        tenant_id: payload['custom:tenant_id'],
                        subscription_tier: payload['custom:subscription_tier'] || 'basic',
                        user_id: payload.sub,
                        token: idToken
                    };
                    
                    showChatInterface();
                },
                onFailure: (err) => {
                    document.getElementById('loginError').textContent = err.message;
                }
            });
        }

        function showChatInterface() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('chatInterface').classList.add('active');
            
            const tierBadge = currentUser.subscription_tier === 'premium' ? 'badge-premium' : 
                             currentUser.subscription_tier === 'advanced' ? 'badge-advanced' : 'badge-basic';
            
            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.textContent = '';
            
            const emailP = document.createElement('p');
            const emailStrong = document.createElement('strong');
            emailStrong.textContent = 'Email:';
            emailP.appendChild(emailStrong);
            emailP.appendChild(document.createTextNode(' ' + currentUser.email));
            
            const orgP = document.createElement('p');
            const orgStrong = document.createElement('strong');
            orgStrong.textContent = 'Organization:';
            orgP.appendChild(orgStrong);
            orgP.appendChild(document.createTextNode(' ' + currentUser.tenant_id));
            
            const subP = document.createElement('p');
            const subStrong = document.createElement('strong');
            subStrong.textContent = 'Subscription:';
            subP.appendChild(subStrong);
            subP.appendChild(document.createTextNode(' '));
            const badge = document.createElement('span');
            badge.className = `badge ${tierBadge}`;
            badge.textContent = currentUser.subscription_tier;
            subP.appendChild(badge);
            
            const userIdP = document.createElement('p');
            const userIdStrong = document.createElement('strong');
            userIdStrong.textContent = 'User ID:';
            userIdP.appendChild(userIdStrong);
            userIdP.appendChild(document.createTextNode(' ' + currentUser.user_id));
            
            userInfoDiv.appendChild(emailP);
            userInfoDiv.appendChild(orgP);
            userInfoDiv.appendChild(subP);
            userInfoDiv.appendChild(userIdP);
            
            // Check if user is admin and show admin controls
            checkAdminAccess();
            
            createSession();
        }
        
        async function checkAdminAccess() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/my-tenants`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const adminData = await response.json();
                    document.getElementById('adminControls').style.display = 'block';
                    const userInfoDiv = document.getElementById('userInfo');
                    
                    const roleP = document.createElement('p');
                    const roleStrong = document.createElement('strong');
                    roleStrong.textContent = 'Role:';
                    roleP.appendChild(roleStrong);
                    roleP.appendChild(document.createTextNode(' '));
                    const adminBadge = document.createElement('span');
                    adminBadge.className = 'badge badge-admin';
                    adminBadge.textContent = 'Admin';
                    roleP.appendChild(adminBadge);
                    
                    const accessP = document.createElement('p');
                    accessP.style.fontSize = '12px';
                    accessP.style.opacity = '0.8';
                    accessP.textContent = 'Admin access for: ' + adminData.admin_tenants.join(', ');
                    
                    userInfoDiv.appendChild(roleP);
                    userInfoDiv.appendChild(accessP);
                }
            } catch (error) {
                // User is not admin, keep admin controls hidden
            }
        }

        async function createSession() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    currentSession = await response.json();
                    addMessageToChat('system', `Session created: ${currentSession.session_id}`);
                } else {
                    addMessageToChat('system', 'Failed to create session');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        async function sendMessage() {
            if (!currentSession) {
                addMessageToChat('system', 'No active session');
                return;
            }
            
            const message = document.getElementById('messageInput').value;
            if (!message) return;
            
            addMessageToChat('user', message);
            document.getElementById('messageInput').value = '';
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        tenant_context: {
                            tenant_id: currentUser.tenant_id,
                            user_id: currentUser.user_id,
                            session_id: currentSession.session_id
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessageToChat('agent', result.response);
                } else {
                    addMessageToChat('system', 'Failed to send message');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        function addMessageToChat(sender, message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const senderLabel = document.createElement('strong');
            senderLabel.textContent = sender + ': ';
            messageDiv.appendChild(senderLabel);
            
            const messageText = document.createTextNode(message);
            messageDiv.appendChild(messageText);
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function getUsage() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/usage`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const usage = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    
                    const title = document.createElement('h3');
                    title.className = 'card-title';
                    title.textContent = 'üìä Usage Statistics';
                    
                    const orgP = document.createElement('p');
                    const orgStrong = document.createElement('strong');
                    orgStrong.textContent = 'Organization:';
                    orgP.appendChild(orgStrong);
                    orgP.appendChild(document.createTextNode(' ' + usage.tenant_id));
                    
                    const msgP = document.createElement('p');
                    const msgStrong = document.createElement('strong');
                    msgStrong.textContent = 'Total Messages:';
                    msgP.appendChild(msgStrong);
                    msgP.appendChild(document.createTextNode(' ' + usage.total_messages));
                    
                    const sessP = document.createElement('p');
                    const sessStrong = document.createElement('strong');
                    sessStrong.textContent = 'Active Sessions:';
                    sessP.appendChild(sessStrong);
                    sessP.appendChild(document.createTextNode(' ' + usage.sessions));
                    
                    const pre = document.createElement('pre');
                    pre.style.cssText = 'background: var(--aws-bg); padding: 15px; border-radius: 8px; overflow-x: auto;';
                    pre.textContent = JSON.stringify(usage.metrics, null, 2);
                    
                    infoPanel.appendChild(title);
                    infoPanel.appendChild(orgP);
                    infoPanel.appendChild(msgP);
                    infoPanel.appendChild(sessP);
                    infoPanel.appendChild(pre);
                }
            } catch (error) {
                console.error('Error getting usage:', error);
            }
        }

        async function getSessions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/sessions`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const sessions = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    
                    const title = document.createElement('h3');
                    title.className = 'card-title';
                    title.textContent = 'üìù Active Sessions';
                    
                    const orgP = document.createElement('p');
                    const orgStrong = document.createElement('strong');
                    orgStrong.textContent = 'Organization:';
                    orgP.appendChild(orgStrong);
                    orgP.appendChild(document.createTextNode(' ' + sessions.tenant_id));
                    
                    const pre = document.createElement('pre');
                    pre.style.cssText = 'background: var(--aws-bg); padding: 15px; border-radius: 8px; overflow-x: auto;';
                    pre.textContent = JSON.stringify(sessions.sessions, null, 2);
                    
                    infoPanel.appendChild(title);
                    infoPanel.appendChild(orgP);
                    infoPanel.appendChild(pre);
                }
            } catch (error) {
                console.error('Error getting sessions:', error);
            }
        }

        async function getMCPTools() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/mcp/tools`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const tools = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    let toolsHtml = `<h3 class="card-title">üîß MCP Tools</h3>
                                    <p><strong>Subscription:</strong> <span class="badge badge-${tools.subscription_tier}">${tools.subscription_tier}</span></p>`;
                    
                    if (tools.available_tools.length === 0) {
                        toolsHtml += '<div style="background: #FDECEA; padding: 15px; border-radius: 8px; margin-top: 15px;"><p>‚ùå No MCP tools available for your subscription tier</p></div>';
                    } else {
                        toolsHtml += '<div style="background: var(--aws-bg); padding: 20px; border-radius: 8px; margin-top: 15px;"><h4 style="margin-bottom: 15px;">Available Tools:</h4><div class="action-grid">';
                        tools.available_tools.forEach(tool => {
                            toolsHtml += `<button class="action-btn btn-warning" onclick="testMCPTool('${tool}')">${tool}</button>`;
                        });
                        toolsHtml += '</div></div>';
                    }
                    
                    infoPanel.textContent = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = toolsHtml;
                    while (tempDiv.firstChild) {
                        infoPanel.appendChild(tempDiv.firstChild);
                    }
                }
            } catch (error) {
                console.error('Error getting MCP tools:', error);
            }
        }

        async function getSubscriptionInfo() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/subscription`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const info = await response.json();
                    const tierBadge = info.subscription_tier === 'premium' ? 'badge-premium' : 
                                     info.subscription_tier === 'advanced' ? 'badge-advanced' : 'badge-basic';
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    
                    const title = document.createElement('h3');
                    title.className = 'card-title';
                    title.textContent = 'üéØ Subscription Details';
                    
                    const tierP = document.createElement('p');
                    const tierStrong = document.createElement('strong');
                    tierStrong.textContent = 'Tier:';
                    tierP.appendChild(tierStrong);
                    tierP.appendChild(document.createTextNode(' '));
                    const badge = document.createElement('span');
                    badge.className = `badge ${tierBadge}`;
                    badge.textContent = info.subscription_tier;
                    tierP.appendChild(badge);
                    
                    const limitsDiv = document.createElement('div');
                    limitsDiv.style.cssText = 'background: var(--aws-bg); padding: 20px; border-radius: 8px; margin: 15px 0;';
                    const limitsH4 = document.createElement('h4');
                    limitsH4.style.cssText = 'margin-bottom: 15px; color: var(--aws-dark);';
                    limitsH4.textContent = 'Plan Limits';
                    limitsDiv.appendChild(limitsH4);
                    
                    const dailyP = document.createElement('p');
                    dailyP.textContent = `‚Ä¢ Daily Messages: ${info.limits.daily_messages}`;
                    const monthlyP = document.createElement('p');
                    monthlyP.textContent = `‚Ä¢ Monthly Messages: ${info.limits.monthly_messages}`;
                    const durationP = document.createElement('p');
                    durationP.textContent = `‚Ä¢ Session Duration: ${info.limits.max_session_duration} minutes`;
                    const concurrentP = document.createElement('p');
                    concurrentP.textContent = `‚Ä¢ Concurrent Sessions: ${info.limits.concurrent_sessions}`;
                    const mcpP = document.createElement('p');
                    mcpP.textContent = '‚Ä¢ MCP Access: ';
                    const mcpStatus = document.createElement('strong');
                    mcpStatus.style.color = info.limits.mcp_server_access ? '#037F0C' : '#D13212';
                    mcpStatus.textContent = info.limits.mcp_server_access ? '‚úÖ Enabled' : '‚ùå Disabled';
                    mcpP.appendChild(mcpStatus);
                    
                    limitsDiv.appendChild(dailyP);
                    limitsDiv.appendChild(monthlyP);
                    limitsDiv.appendChild(durationP);
                    limitsDiv.appendChild(concurrentP);
                    limitsDiv.appendChild(mcpP);
                    
                    const usageDiv = document.createElement('div');
                    usageDiv.style.cssText = 'background: linear-gradient(135deg, #E9F7EF 0%, #D4EDDA 100%); padding: 20px; border-radius: 8px;';
                    const usageH4 = document.createElement('h4');
                    usageH4.style.cssText = 'margin-bottom: 15px; color: var(--aws-dark);';
                    usageH4.textContent = 'Current Usage';
                    usageDiv.appendChild(usageH4);
                    
                    const dailyUsageP = document.createElement('p');
                    dailyUsageP.textContent = `‚Ä¢ Daily: ${info.current_usage.daily_usage}/${info.limits.daily_messages} (${((info.current_usage.daily_usage/info.limits.daily_messages)*100).toFixed(1)}%)`;
                    const monthlyUsageP = document.createElement('p');
                    monthlyUsageP.textContent = `‚Ä¢ Monthly: ${info.current_usage.monthly_usage}/${info.limits.monthly_messages} (${((info.current_usage.monthly_usage/info.limits.monthly_messages)*100).toFixed(1)}%)`;
                    const activeSessionsP = document.createElement('p');
                    activeSessionsP.textContent = `‚Ä¢ Active Sessions: ${info.current_usage.active_sessions}/${info.limits.concurrent_sessions}`;
                    
                    usageDiv.appendChild(dailyUsageP);
                    usageDiv.appendChild(monthlyUsageP);
                    usageDiv.appendChild(activeSessionsP);
                    
                    infoPanel.appendChild(title);
                    infoPanel.appendChild(tierP);
                    infoPanel.appendChild(limitsDiv);
                    infoPanel.appendChild(usageDiv);
                }
            } catch (error) {
                console.error('Error getting subscription info:', error);
            }
        }

        async function testMCPTool(toolName) {
            if (!currentUser) return;
            
            const testArgs = {
                'get_tier_info': { tier: currentUser.subscription_tier },
                'upgrade_tier': { tenant_id: currentUser.tenant_id, new_tier: 'premium' },
                'get_usage_analytics': { tenant_id: currentUser.tenant_id },
                'manage_limits': { action: 'increase', tenant_id: currentUser.tenant_id, limit_type: 'daily' }
            };
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/mcp/tools/${toolName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testArgs[toolName] || {})
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessageToChat('system', `MCP Tool ${toolName}: ${JSON.stringify(result.result, null, 2)}`);
                } else {
                    addMessageToChat('system', `MCP Tool ${toolName} failed`);
                }
            } catch (error) {
                addMessageToChat('system', `Error executing MCP tool: ${error.message}`);
            }
        }

        function confirmSignUp(email, tenantId, isAdmin) {
            const verificationCode = document.getElementById('verificationCode').value;
            
            const userData = {
                Username: email,
                Pool: userPool
            };
            
            const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.confirmRegistration(verificationCode, true, async (err, result) => {
                if (err) {
                    document.getElementById('registerError').textContent = err.message;
                    return;
                }
                
                // If admin role, add to admin group
                if (isAdmin) {
                    try {
                        const response = await fetch(`${CONFIG.apiUrl}/api/admin/add-to-group`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: email,
                                tenant_id: tenantId
                            })
                        });
                        
                        if (response.ok) {
                            document.getElementById('registerSuccess').textContent = 
                                '‚úÖ Email verified and admin access granted! You can now login with admin privileges.';
                        } else {
                            document.getElementById('registerSuccess').textContent = 
                                '‚úÖ Email verified! Admin access pending - contact support.';
                        }
                    } catch (error) {
                        document.getElementById('registerSuccess').textContent = 
                            '‚úÖ Email verified! Admin access pending - contact support.';
                    }
                } else {
                    document.getElementById('registerSuccess').textContent = 
                        '‚úÖ Email verified successfully! You can now login.';
                }
                
                document.getElementById('registerError').textContent = '';
            });
        }

        async function getCostReport() {
            if (!currentUser) return;
            
            const days = prompt('Enter number of days for cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/costs?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    const costHtml = `
                        <h3 class="card-title">üí∞ Cost Report (${daysParam} days)</h3>
                        <div style="background: linear-gradient(135deg, #FFF3CD 0%, #FFE69C 100%); padding: 20px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="color: var(--aws-dark); margin-bottom: 15px;">Total Cost: $${data.total_cost.toFixed(4)}</h4>
                            <p>‚Ä¢ <strong>Bedrock:</strong> $${data.cost_breakdown.bedrock_costs.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>Weather API:</strong> $${data.cost_breakdown.weather_api_costs.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>Agent Runtime:</strong> $${data.cost_breakdown.agent_runtime_costs.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>Total Invocations:</strong> ${data.cost_breakdown.total_invocations}</p>
                            <p>‚Ä¢ <strong>Total Tokens:</strong> ${data.cost_breakdown.total_tokens.input + data.cost_breakdown.total_tokens.output}</p>
                        </div>
                        <h4 style="margin: 20px 0 10px 0;">User Breakdown:</h4>
                        <div style="max-height: 250px; overflow-y: auto; background: var(--aws-bg); padding: 15px; border-radius: 8px;">
                            ${Object.entries(data.users).map(([userId, userCost]) => 
                                `<p style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px;"><strong>${userId}:</strong> $${userCost.total_cost.toFixed(4)} <span style="color: var(--aws-gray); font-size: 12px;">(${userCost.invocations} invocations)</span></p>`
                            ).join('')}
                        </div>
                    `;
                    infoPanel.textContent = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = costHtml;
                    while (tempDiv.firstChild) {
                        infoPanel.appendChild(tempDiv.firstChild);
                    }
                } else {
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    const errorP = document.createElement('p');
                    errorP.className = 'error';
                    errorP.textContent = 'Error loading cost report';
                    infoPanel.appendChild(errorP);
                }
            } catch (error) {
                console.error('Error getting cost report:', error);
            }
        }
        
        async function getUserCosts() {
            if (!currentUser) return;
            
            const days = prompt('Enter number of days for your cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/users/${currentUser.user_id}/costs?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    const userCostHtml = `
                        <h3 class="card-title">üë§ My Costs (${daysParam} days)</h3>
                        <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="color: var(--aws-dark); margin-bottom: 15px;">My Total Cost: $${data.total_cost.toFixed(4)}</h4>
                            <p>‚Ä¢ <strong>Bedrock:</strong> $${data.bedrock_cost.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>Weather API:</strong> $${data.weather_api_cost.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>Agent Runtime:</strong> $${data.agent_runtime_cost.toFixed(4)}</p>
                            <p>‚Ä¢ <strong>My Invocations:</strong> ${data.invocations}</p>
                            <p>‚Ä¢ <strong>My Tokens:</strong> ${data.tokens.input + data.tokens.output} <span style="color: var(--aws-gray); font-size: 12px;">(${data.tokens.input} input, ${data.tokens.output} output)</span></p>
                        </div>
                    `;
                    infoPanel.textContent = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = userCostHtml;
                    while (tempDiv.firstChild) {
                        infoPanel.appendChild(tempDiv.firstChild);
                    }
                } else {
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    const errorP = document.createElement('p');
                    errorP.className = 'error';
                    errorP.textContent = 'Error loading your cost report';
                    infoPanel.appendChild(errorP);
                }
            } catch (error) {
                console.error('Error getting user costs:', error);
            }
        }

        async function getAdminOverallCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for admin overall cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/overall-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    const adminHtml = `
                        <h3 class="card-title">üîí ADMIN: Overall Tenant Cost (${daysParam} days)</h3>
                        <div style="background: linear-gradient(135deg, #FDECEA 0%, #F8D7DA 100%); padding: 20px; border-radius: 8px; border: 2px solid #D13212;">
                            <h4 style="color: var(--aws-dark); margin-bottom: 15px;">Total: $${data.total_cost.toFixed(4)}</h4>
                            <h5 style="margin: 15px 0 10px 0;">Service Breakdown:</h5>
                            ${Object.entries(data.service_breakdown).map(([service, cost]) => 
                                `<p style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px;"><strong>${service}:</strong> $${cost.toFixed(4)} <span class="badge badge-admin">${data.cost_per_service_percentage[service].toFixed(1)}%</span></p>`
                            ).join('')}
                        </div>
                    `;
                    infoPanel.textContent = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = adminHtml;
                    while (tempDiv.firstChild) {
                        infoPanel.appendChild(tempDiv.firstChild);
                    }
                } else {
                    const infoPanel = document.getElementById('usageInfo');
                    infoPanel.style.display = 'block';
                    infoPanel.textContent = '';
                    const errorP = document.createElement('p');
                    errorP.className = 'error';
                    errorP.textContent = 'Admin access required';
                    infoPanel.appendChild(errorP);
                }
            } catch (error) {
                const infoPanel = document.getElementById('usageInfo');
                infoPanel.style.display = 'block';
                infoPanel.textContent = '';
                const errorP = document.createElement('p');
                errorP.className = 'error';
                errorP.textContent = 'Admin access required';
                infoPanel.appendChild(errorP);
            }
        }
        
        async function getAdminPerUserCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for per-user cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/per-user-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userList = Object.entries(data.users).map(([userId, userData]) => 
                        `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px;">
                            <strong>${userId}:</strong> $${userData.total_cost.toFixed(4)}<br>
                            <small>Invocations: ${userData.usage_stats.invocations}, Tokens: ${userData.usage_stats.tokens.input + userData.usage_stats.tokens.output}</small>
                        </div>`
                    ).join('');
                    
                    const usageInfo = document.getElementById('usageInfo');
                    usageInfo.textContent = '';
                    
                    const title = document.createElement('h3');
                    title.textContent = `üîí ADMIN: Per User Costs (${daysParam} days)`;
                    
                    const div = document.createElement('div');
                    div.style.cssText = 'max-height: 300px; overflow-y: auto;';
                    div.textContent = userList;
                    
                    usageInfo.appendChild(title);
                    usageInfo.appendChild(div);
                }
            } catch (error) {
                const usageInfo = document.getElementById('usageInfo'); usageInfo.textContent = ''; const errorP = document.createElement('p'); errorP.textContent = 'Admin access required'; usageInfo.appendChild(errorP);
            }
        }
        
        async function getAdminServiceCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for service-wise cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/service-wise-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const serviceList = Object.entries(data.service_breakdown).map(([service, serviceData]) => 
                        `<div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 3px;">
                            <strong>${service}:</strong> $${serviceData.total_cost.toFixed(4)}<br>
                            <small>Usage: ${serviceData.usage_count}, Avg: $${serviceData.average_cost_per_use.toFixed(6)}</small><br>
                            <small>Peak Day: ${serviceData.peak_usage_day.date} ($${serviceData.peak_usage_day.cost.toFixed(4)})</small>
                        </div>`
                    ).join('');
                    
                    const usageInfo = document.getElementById('usageInfo');
                    usageInfo.textContent = '';
                    
                    const title = document.createElement('h3');
                    title.textContent = `üîí ADMIN: Service-wise Costs (${daysParam} days)`;
                    
                    const div = document.createElement('div');
                    div.style.cssText = 'max-height: 300px; overflow-y: auto;';
                    div.textContent = serviceList;
                    
                    usageInfo.appendChild(title);
                    usageInfo.appendChild(div);
                }
            } catch (error) {
                const usageInfo = document.getElementById('usageInfo'); usageInfo.textContent = ''; const errorP = document.createElement('p'); errorP.textContent = 'Admin access required'; usageInfo.appendChild(errorP);
            }
        }
        
        async function getComprehensiveReport() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for comprehensive admin report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/comprehensive-report?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const reportHtml = `
                        <h3>üîí ADMIN: Comprehensive Cost Report (${daysParam} days)</h3>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                            <h4>Summary</h4>
                            <p><strong>Total Cost:</strong> $${data.summary.total_tenant_cost.toFixed(4)}</p>
                            <p><strong>Total Users:</strong> ${data.summary.total_users}</p>
                            <p><strong>Highest Cost Service:</strong> ${data.summary.highest_cost_service}</p>
                            <p><strong>Most Expensive User:</strong> ${data.summary.most_expensive_user}</p>
                            
                            <h5>Top Users by Cost:</h5>
                            ${Object.entries(data['4_top_users_by_cost']).map(([userId, userData]) => 
                                `<p>${userId}: $${userData.total_cost.toFixed(4)}</p>`
                            ).join('')}
                        </div>
                    `;
                    const usageInfo = document.getElementById('usageInfo');
                    usageInfo.textContent = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = reportHtml;
                    while (tempDiv.firstChild) {
                        usageInfo.appendChild(tempDiv.firstChild);
                    }
                }
            } catch (error) {
                const usageInfo = document.getElementById('usageInfo'); usageInfo.textContent = ''; const errorP = document.createElement('p'); errorP.textContent = 'Admin access required'; usageInfo.appendChild(errorP);
            }
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
        }
        
        function showLoginForm() {
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
        }
        
        function logout() {
            if (cognitoUser) {
                cognitoUser.signOut();
            }
            currentUser = null;
            currentSession = null;
            cognitoUser = null;
            
            document.getElementById('chatInterface').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('chatBox').textContent = '';
            document.getElementById('usageInfo').textContent = '';
            document.getElementById('adminControls').style.display = 'none';
        }

        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>