name: Deploy MCP-Agent Core Multi-Tenant System

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'
  COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
  COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
  BEDROCK_AGENT_ID: ${{ secrets.BEDROCK_AGENT_ID }}
  OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
  SESSIONS_TABLE: ${{ secrets.SESSIONS_TABLE }}
  USAGE_TABLE: ${{ secrets.USAGE_TABLE }}

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      user-pool-id: ${{ steps.cdk-outputs.outputs.user-pool-id }}
      client-id: ${{ steps.cdk-outputs.outputs.client-id }}
      agent-id: ${{ steps.cdk-outputs.outputs.agent-id }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python
      uses: actions/setup-python@65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236  # v4.7.1
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Setup Node.js for CDK
      uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
      with:
        node-version: '18'

    - name: Install CDK
      run: npm install -g aws-cdk

    - name: Install CDK dependencies
      run: |
        cd infrastructure/cdk
        pip install -r requirements.txt

    - name: CDK Bootstrap
      run: |
        cd infrastructure/cdk
        cdk bootstrap

    - name: Deploy CDK Stack
      run: |
        cd infrastructure/cdk
        cdk deploy --require-approval never --outputs-file outputs.json

    - name: Install Python dependencies for Bedrock Agent
      run: pip install boto3

    - name: Create Bedrock Agent
      run: |
        python deployment/scripts/create_bedrock_agent.py > bedrock_agent_output.txt 2>&1 || echo "Bedrock Agent creation failed, using fallback"
        echo "ðŸ“ Bedrock Agent Output:"
        cat bedrock_agent_output.txt

    - name: Extract CDK Outputs
      id: cdk-outputs
      run: |
        # Get CDK outputs
        USER_POOL_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolId' infrastructure/cdk/outputs.json)
        CLIENT_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolClientId' infra/cdk/outputs.json)
        
        # Extract Agent ID from bedrock agent creation output
        if [ -f "bedrock_agent_output.txt" ]; then
          AGENT_ID=$(grep "Agent ID:" bedrock_agent_output.txt | cut -d':' -f2 | xargs)
        else
          AGENT_ID="fallback-direct-model"
        fi
        
        echo "user-pool-id=$USER_POOL_ID" >> $GITHUB_OUTPUT
        echo "client-id=$CLIENT_ID" >> $GITHUB_OUTPUT
        echo "agent-id=$AGENT_ID" >> $GITHUB_OUTPUT
        
        echo "âœ… Extracted outputs:"
        echo "   User Pool ID: $USER_POOL_ID"
        echo "   Client ID: $CLIENT_ID"
        echo "   Agent ID: $AGENT_ID"

  setup-frontend:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      BEDROCK_AGENT_ID: ${{ secrets.BEDROCK_AGENT_ID }}
      OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      SESSIONS_TABLE: ${{ secrets.SESSIONS_TABLE }}
      USAGE_TABLE: ${{ secrets.USAGE_TABLE }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Update Frontend Configuration
      run: |
        USER_POOL_ID="${{ needs.deploy-infrastructure.outputs.user-pool-id }}"
        CLIENT_ID="${{ needs.deploy-infrastructure.outputs.client-id }}"

        # Next.js client uses environment variables via client/.env.local
        echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$USER_POOL_ID" >> client/.env.local
        echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=$CLIENT_ID" >> client/.env.local

        echo "âœ… Frontend configured with:"
        echo "   User Pool ID: $USER_POOL_ID"
        echo "   Client ID: $CLIENT_ID"
        echo "ðŸŒ Frontend (Next.js) in client/"
        
    - name: Create Environment File
      run: |
        cat > .env << EOF
        COGNITO_USER_POOL_ID=${{ env.COGNITO_USER_POOL_ID }}
        COGNITO_CLIENT_ID=${{ env.COGNITO_CLIENT_ID }}
        BEDROCK_AGENT_ID=${{ env.BEDROCK_AGENT_ID }}
        OPENWEATHER_API_KEY=${{ env.OPENWEATHER_API_KEY }}
        SESSIONS_TABLE=${{ env.SESSIONS_TABLE }}
        USAGE_TABLE=${{ env.USAGE_TABLE }}
        AWS_REGION=us-east-1
        DEBUG=false
        PORT=8000
        EOF
        echo "âœ… Environment file created for deployment"

