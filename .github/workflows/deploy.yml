name: Deploy Multi-Tenant Bedrock Chat

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      user-pool-id: ${{ steps.cdk-outputs.outputs.user-pool-id }}
      client-id: ${{ steps.cdk-outputs.outputs.client-id }}
      agent-id: ${{ steps.cdk-outputs.outputs.agent-id }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Setup Node.js for CDK
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install CDK
      run: npm install -g aws-cdk

    - name: Install CDK dependencies
      run: |
        cd infra/cdk
        pip install -r requirements.txt

    - name: CDK Bootstrap
      run: |
        cd infra/cdk
        cdk bootstrap

    - name: Deploy CDK Stack
      run: |
        cd infra/cdk
        cdk deploy --require-approval never --outputs-file outputs.json

    - name: Install Python dependencies for Bedrock Agent
      run: pip install boto3

    - name: Create Bedrock Agent
      run: |
        python scripts/create_bedrock_agent.py > bedrock_agent_output.txt 2>&1 || echo "Bedrock Agent creation failed, using fallback"
        echo "ðŸ“ Bedrock Agent Output:"
        cat bedrock_agent_output.txt

    - name: Extract CDK Outputs
      id: cdk-outputs
      run: |
        # Get CDK outputs
        USER_POOL_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolId' infra/cdk/outputs.json)
        CLIENT_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolClientId' infra/cdk/outputs.json)
        
        # Extract Agent ID from bedrock agent creation output
        if [ -f "bedrock_agent_output.txt" ]; then
          AGENT_ID=$(grep "Agent ID:" bedrock_agent_output.txt | cut -d':' -f2 | xargs)
        else
          AGENT_ID="fallback-direct-model"
        fi
        
        echo "user-pool-id=$USER_POOL_ID" >> $GITHUB_OUTPUT
        echo "client-id=$CLIENT_ID" >> $GITHUB_OUTPUT
        echo "agent-id=$AGENT_ID" >> $GITHUB_OUTPUT
        
        echo "âœ… Extracted outputs:"
        echo "   User Pool ID: $USER_POOL_ID"
        echo "   Client ID: $CLIENT_ID"
        echo "   Agent ID: $AGENT_ID"

  create-users:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      jwt-secret: ${{ steps.jwt-secret.outputs.jwt-secret }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Generate JWT Secret
      id: jwt-secret
      run: |
        JWT_SECRET=$(python -c "import secrets; print(secrets.token_urlsafe(32))")
        echo "jwt-secret=$JWT_SECRET" >> $GITHUB_OUTPUT
        echo "Generated JWT Secret: $JWT_SECRET"

    - name: Create test users
      env:
        COGNITO_USER_POOL_ID: ${{ needs.deploy-infrastructure.outputs.user-pool-id }}
        COGNITO_CLIENT_ID: ${{ needs.deploy-infrastructure.outputs.client-id }}
        JWT_SECRET: ${{ steps.jwt-secret.outputs.jwt-secret }}
      run: python scripts/create_test_user.py

  test:
    needs: [deploy-infrastructure, create-users]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Test Bedrock Agent Chatbot
      env:
        COGNITO_USER_POOL_ID: ${{ needs.deploy-infrastructure.outputs.user-pool-id }}
        COGNITO_CLIENT_ID: ${{ needs.deploy-infrastructure.outputs.client-id }}
        BEDROCK_AGENT_ID: ${{ needs.deploy-infrastructure.outputs.agent-id }}
        JWT_SECRET: ${{ needs.create-users.outputs.jwt-secret }}
        AWS_REGION: ${{ env.AWS_REGION }}
      run: |
        echo "ðŸ¤– Testing Bedrock Agent Core Chatbot Application"
        
        # Test runtime context patterns
        python examples/runtime_context_demo.py
        
        # Test multi-tenant chatbot functionality
        python test_client.py
        
        echo "âœ… Bedrock Agent chatbot tests completed"