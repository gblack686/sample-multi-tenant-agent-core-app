name: Deploy MCP-Agent Core Multi-Tenant System

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      user-pool-id: ${{ steps.cdk-outputs.outputs.user-pool-id }}
      client-id: ${{ steps.cdk-outputs.outputs.client-id }}
      agent-id: ${{ steps.cdk-outputs.outputs.agent-id }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Setup Node.js for CDK
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install CDK
      run: npm install -g aws-cdk

    - name: Install CDK dependencies
      run: |
        cd infra/cdk
        pip install -r requirements.txt

    - name: CDK Bootstrap
      run: |
        cd infra/cdk
        cdk bootstrap

    - name: Deploy CDK Stack
      run: |
        cd infra/cdk
        cdk deploy --require-approval never --outputs-file outputs.json

    - name: Install Python dependencies for Bedrock Agent
      run: pip install boto3

    - name: Create Bedrock Agent
      run: |
        python scripts/create_bedrock_agent.py > bedrock_agent_output.txt 2>&1 || echo "Bedrock Agent creation failed, using fallback"
        echo "üìù Bedrock Agent Output:"
        cat bedrock_agent_output.txt

    - name: Extract CDK Outputs
      id: cdk-outputs
      run: |
        # Get CDK outputs
        USER_POOL_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolId' infra/cdk/outputs.json)
        CLIENT_ID=$(jq -r '.MultiTenantBedrockStack.UserPoolClientId' infra/cdk/outputs.json)
        
        # Extract Agent ID from bedrock agent creation output
        if [ -f "bedrock_agent_output.txt" ]; then
          AGENT_ID=$(grep "Agent ID:" bedrock_agent_output.txt | cut -d':' -f2 | xargs)
        else
          AGENT_ID="fallback-direct-model"
        fi
        
        echo "user-pool-id=$USER_POOL_ID" >> $GITHUB_OUTPUT
        echo "client-id=$CLIENT_ID" >> $GITHUB_OUTPUT
        echo "agent-id=$AGENT_ID" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Extracted outputs:"
        echo "   User Pool ID: $USER_POOL_ID"
        echo "   Client ID: $CLIENT_ID"
        echo "   Agent ID: $AGENT_ID"

  setup-frontend:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Update Frontend Configuration
      run: |
        USER_POOL_ID="${{ needs.deploy-infrastructure.outputs.user-pool-id }}"
        CLIENT_ID="${{ needs.deploy-infrastructure.outputs.client-id }}"
        
        # Update frontend configuration
        sed -i "s/userPoolId: 'UPDATE_FROM_DEPLOYMENT'/userPoolId: '$USER_POOL_ID'/g" frontend/index.html
        sed -i "s/clientId: 'UPDATE_FROM_DEPLOYMENT'/clientId: '$CLIENT_ID'/g" frontend/index.html
        
        echo "‚úÖ Frontend configured with:"
        echo "   User Pool ID: $USER_POOL_ID"
        echo "   Client ID: $CLIENT_ID"
        echo "üåê Frontend ready at: http://localhost:8000"
        echo "üìù Manual user registration available with subscription tier selection"

  test:
    needs: [deploy-infrastructure, setup-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Validate MCP-Agent Core System
      env:
        COGNITO_USER_POOL_ID: ${{ needs.deploy-infrastructure.outputs.user-pool-id }}
        COGNITO_CLIENT_ID: ${{ needs.deploy-infrastructure.outputs.client-id }}
        BEDROCK_AGENT_ID: ${{ needs.deploy-infrastructure.outputs.agent-id }}
        AWS_REGION: ${{ env.AWS_REGION }}
      run: |
        echo "üîç Validating MCP-Agent Core System"
        
        # Test subscription tier configuration
        python -c "
        from app.models import SubscriptionTier
        from app.subscription_service import SubscriptionService
        from app.dynamodb_store import DynamoDBStore
        
        store = DynamoDBStore()
        service = SubscriptionService(store)
        
        print('Subscription Tiers Configured:')
        for tier in [SubscriptionTier.BASIC, SubscriptionTier.ADVANCED, SubscriptionTier.PREMIUM]:
            limits = service.get_tier_limits(tier)
            print(f'  {tier.value}: {limits.daily_messages} daily, MCP: {limits.mcp_server_access}')
        "
        
        # Test MCP service initialization
        python -c "
        from app.mcp_service import MCPClient
        from app.models import SubscriptionTier
        import asyncio
        
        async def test_mcp():
            client = MCPClient()
            for tier in [SubscriptionTier.BASIC, SubscriptionTier.ADVANCED, SubscriptionTier.PREMIUM]:
                tools = await client.get_available_tools(tier)
                print(f'{tier.value} tier MCP tools: {len(tools)} available')
        
        asyncio.run(test_mcp())
        "
        
        echo "‚úÖ System validation completed - Ready for manual testing"